name: Auto update 3.7 branch

on:
    push:
        branches:
            - master
        paths: ['src/phub/**']
    
    workflow_dispatch:

jobs:
    translate:
        runs-on: ubuntu-latest

        steps:
            - name: Set up Python 3.11
              uses: actions/setup-python@v2
              with:
                python-version: 3.11

            - name: Checkout master branch
              uses: actions/checkout@v2
              with:
                ref: master
            
            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt
                pip install pytest
            
            - name: Run translation script
              run: |
                #!/bin/bash
                find . -type f -name "*.py" | while read -r file; do
                  echo "*** Translating $file ***"
                  python .github/workflows/translate.py "$file"
                done
            
            - name: Run pytest
              run: python -m pytest
            
            - name: Commit changes
              run: |
                git config --local user.email "action@github.com"
                git config --local user.name "GitHub Action"
                git add .
                git commit -m "Automatic translation"
            
            - name: Create pull request
              run: gh pr create --base py-3.7 --head master --title "Translate to 3.7" --body "Automatic update for the 3.7 branch following a successfull pytest run."
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}